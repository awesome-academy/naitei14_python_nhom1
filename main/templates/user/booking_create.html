{% extends 'main/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Book Pitch" %} - {{ pitch.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/booking_create.css' %}">
{% endblock %}

{% block content %}
<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">
                    <i class="fas fa-calendar-check"></i> {% trans "Book Pitch" %}
                </h4>
            </div>
            <div class="card-body">

                <!-- Pitch Info -->
                <div class="alert alert-info mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="mb-1">
                                <i class="fas fa-futbol"></i> {{ pitch.name }}
                            </h5>
                            <p class="mb-1">
                                <i class="fas fa-map-marker-alt"></i>
                                {{ pitch.facility.address|default:"No address" }}
                            </p>
                            <p class="mb-0">
                                <i class="fas fa-tag"></i>
                                {% trans "Pitch Type" %}: {{ pitch.pitch_type.name|default:"N/A" }}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-warning text-dark fs-5">
                                {{ pitch.base_price_per_hour|floatformat:0 }}đ/{% trans "hour" %}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Booking Form -->
                <form method="post" id="bookingForm">
                    {% csrf_token %}

                    <!-- Hidden pitch field -->
                    <input type="hidden" name="pitch" value="{{ pitch.id }}">

                    <!-- Step 1: Chọn ngày -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-calendar"></i>
                            {% trans "Step 1: Select Booking Date" %}
                            <span class="text-danger">*</span>
                        </label>
                        <input type="date" name="booking_date" id="bookingDate"
                            class="form-control form-control-lg {% if form.booking_date.errors %}is-invalid{% endif %}"
                            value="{{ booking_date|date:'Y-m-d'|default:'' }}" min="{{ today }}" required>
                        {% if form.booking_date.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.booking_date.errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Step 2: Chọn khung giờ -->
                    {% if booking_date %}
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-clock"></i>
                            {% trans "Step 2: Select Time Slot" %}
                            <span class="text-danger">*</span>
                        </label>

                        <input type="hidden" name="time_slot" id="selectedTimeSlot" value="" required>

                        {% if available_time_slots %}
                        <div class="row g-3" id="timeSlotsGrid">
                            {% for slot in available_time_slots %}
                            <div class="col-md-6">
                                <div class="card time-slot-card {{ slot.is_available|yesno:',disabled' }}"
                                    data-slot-id="{{ slot.id }}" data-slot-name="{{ slot.name }}"
                                    data-slot-time="{{ slot.start_time|time:'H:i' }} - {{ slot.end_time|time:'H:i' }}"
                                    data-slot-price="{{ slot.price }}"
                                    {% if slot.discounted_price %}data-slot-discounted-price="{{ slot.discounted_price }}"{% endif %}
                                    data-available="{{ slot.is_available|yesno:'true,false' }}">

                                    <div class="card-body py-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">{{ slot.name }}</h6>
                                                <small class="text-muted">
                                                    <i class="far fa-clock"></i>
                                                    {{ slot.start_time|time:"H:i" }} - {{ slot.end_time|time:"H:i" }}
                                                    <br>
                                                    <i class="fas fa-hourglass-half"></i>
                                                    {{ slot.duration }} {% trans "hours" %}
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                <span class="price-tag text-success">
                                                <span class="price-original {% if slot.discounted_price %}text-decoration-line-through text-muted{% endif %}">
                                                  {{ slot.price|floatformat:0 }}đ
                                                </span>
                                                {% if slot.discounted_price %}
                                                <span class="price-discount ms-1 text-danger fw-semibold">
                                                  {{ slot.discounted_price|floatformat:0 }}đ
                                                </span>
                                                {% endif %}
                                                </span>
                                                <br>
                                                {% if slot.is_available %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check"></i> {% trans "Available" %}
                                                </span>
                                                {% else %}
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-times"></i> {% trans "Booked" %}
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            {% trans "No available time slots for this date" %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Step 3: Voucher -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-ticket-alt"></i>
                            {% trans "Step 3: Discount Code (Optional)" %}
                        </label>
                        <div class="input-group">
                            <input type="text" name="voucher_code" id="voucherCode" class="form-control"
                                placeholder="{% trans 'Enter discount code' %}">
                            <button type="button" class="btn btn-outline-secondary" id="checkVoucherBtn">
                                {% trans "Check" %}
                            </button>
                        </div>
                        <div id="voucherMessage" class="form-text"></div>
                    </div>

                    <!-- Step 4: Ghi chú -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-sticky-note"></i>
                            {% trans "Step 4: Note (Optional)" %}
                        </label>
                        <textarea name="note" class="form-control" rows="3"
                            placeholder="{% trans 'Example: Need ball, arrive 15 minutes early...' %}"></textarea>
                    </div>

                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i>
                        {% trans "Please select a date above to see available time slots" %}
                    </div>
                    {% endif %}

                    <!-- Submit Buttons -->
                    <div class="d-grid gap-2">
                        {% if booking_date and available_time_slots %}
                        <button type="submit" class="btn btn-success btn-lg" id="submitBtn" disabled>
                            <i class="fas fa-check"></i> {% trans "Confirm Booking" %}
                        </button>
                        {% endif %}
                        <a href="{% url 'facility_detail' pitch.facility.id %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> {% trans "Back" %}
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Accordion -->
        <div class="accordion shadow mb-4" id="bookingAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingInstructions">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseInstructions" aria-expanded="true">
                        <i class="fas fa-question-circle me-2 text-info"></i> {% trans "Booking Instructions" %}
                    </button>
                </h2>
                <div id="collapseInstructions" class="accordion-collapse collapse show" data-bs-parent="#bookingAccordion">
                    <div class="accordion-body bg-light">
                        <ol class="ps-3 mb-0 small">
                            <li class="mb-2">{% trans "Select booking date" %}</li>
                            <li class="mb-2">{% trans "Select available time slot (green)" %}</li>
                            <li class="mb-2">{% trans "Enter discount code if you have one" %}</li>
                            <li class="mb-2">{% trans "Add note if needed" %}</li>
                            <li>{% trans "Click Confirm Booking" %}</li>
                        </ol>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header" id="headingNotes">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseNotes">
                        <i class="fas fa-info-circle me-2 text-warning"></i> {% trans "Important Notes" %}
                    </button>
                </h2>
                <div id="collapseNotes" class="accordion-collapse collapse" data-bs-parent="#bookingAccordion">
                    <div class="accordion-body bg-light">
                        <ul class="list-unstyled mb-0 small">
                            <li class="mb-2">
                                <i class="fas fa-clock text-primary me-1"></i>
                                {% trans "Book at least 1 day in advance" %}
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-credit-card text-success me-1"></i>
                                {% trans "Pay when you arrive" %}
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-ban text-danger me-1"></i>
                                {% trans "Free cancellation before 24 hours" %}
                            </li>
                            <li>
                                <i class="fas fa-phone text-info me-1"></i>
                                {% trans "Hotline: 0123-456-789" %}
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    window.checkVoucherUrl = "{% url 'ajax_check_voucher' %}";
</script>
<script type="module" src="{% static 'js/booking_create.js' %}"></script>
{% endblock %}
